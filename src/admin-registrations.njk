---
layout: base
title: Registrations
permalink: /admin/registrations/index.html
---
<section class="container py-12">
  <h1 class="text-3xl font-bold mb-6">Lesson Registrations</h1>
  <p class="text-sm mb-4">You must be logged in (admin) via Netlify Identity for this to work.</p>
  <div class="mb-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <label class="block text-sm">Slug filter
      <input id="filter-slug" class="border rounded px-2 py-1 w-full" placeholder="optional" />
    </label>
    <label class="block text-sm">Start date
      <input id="filter-start" type="date" class="border rounded px-2 py-1 w-full" />
    </label>
    <label class="block text-sm">End date
      <input id="filter-end" type="date" class="border rounded px-2 py-1 w-full" />
    </label>
    <div class="flex items-end gap-2 flex-wrap">
      <button id="load" class="btn">Load</button>
      <button id="export" class="btn">CSV</button>
      <button id="export-uniq" class="btn" title="Unique emails">Emails</button>
      <button id="toggle-mask" class="btn" title="Mask/unmask emails">Mask</button>
    </div>
  </div>
  <div class="text-sm mb-4">
    <label class="inline-flex items-center gap-2"><input type="checkbox" id="auto-refresh" /> <span>Auto refresh (30s)</span></label>
  </div>
  <div id="status" class="text-sm text-gray-600 mb-4">Idle</div>
  <div class="overflow-auto">
    <table class="min-w-full text-sm" id="table">
      <thead>
        <tr class="border-b">
          <th class="text-left py-2 pr-4">Lesson Slug</th>
          <th class="text-left py-2 pr-4">Name</th>
          <th class="text-left py-2 pr-4">Email</th>
          <th class="text-left py-2 pr-4">Registered At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<script>
let masked = true;
let timer = null;
function maskEmail(e){
  if(!masked) return e;
  const [u, d] = e.split('@');
  if(!d) return e;
  return u[0] + '***@' + d;
}
function buildUrl(base){
  const slug = document.getElementById('filter-slug').value.trim();
  const start = document.getElementById('filter-start').value;
  const end = document.getElementById('filter-end').value;
  const params = new URLSearchParams();
  if(slug) params.set('slug', slug);
  if(start) params.set('start', start);
  if(end) params.set('end', end);
  const qs = params.toString();
  return qs ? base + '?' + qs : base;
}
async function load(){
  const status = document.getElementById('status');
  status.textContent = 'Loadingâ€¦';
  const url = buildUrl('/api/admin/registrations');
  try {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'Error');
    const tbody = document.querySelector('#table tbody');
    tbody.innerHTML = '';
    data.forEach(r => {
      if(filterDate(r.created_at)){
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `<td class='py-1 pr-4 font-mono text-xs'>${r.lesson_slug}</td><td class='py-1 pr-4'>${r.name}</td><td class='py-1 pr-4 email-cell' data-email='${r.email}'>${maskEmail(r.email)}</td><td class='py-1 pr-4'>${new Date(r.created_at).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      }
    });
    status.textContent = `${tbody.children.length} registrations shown.`;
  } catch(err){
    status.textContent = err.message;
  }
}
function filterDate(created){
  const start = document.getElementById('filter-start').value;
  const end = document.getElementById('filter-end').value;
  if(!start && !end) return true;
  const dt = new Date(created);
  if(start && dt < new Date(start)) return false;
  if(end){ const endDt = new Date(end); endDt.setDate(endDt.getDate()+1); if(dt >= endDt) return false; }
  return true;
}
function exportCsv(unique=false){
  const tableRows = Array.from(document.querySelectorAll('#table tbody tr'));
  if(unique){
    const emails = new Set();
    tableRows.forEach(r => emails.add(r.querySelector('.email-cell').dataset.email));
    const blob = new Blob([Array.from(emails).join('\n')], { type: 'text/plain' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'emails.txt'; a.click();
  } else {
    const lines = ['lesson_slug,name,email,created_at'];
    tableRows.forEach(r => {
      const tds = r.querySelectorAll('td');
      lines.push([tds[0].textContent, tds[1].textContent.replace(/,/g,' '), tds[2].dataset.email, tds[3].textContent].join(','));
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='registrations.csv'; a.click();
  }
}
function toggleMask(){
  masked = !masked;
  document.querySelectorAll('.email-cell').forEach(td => {
    td.textContent = masked ? maskEmail(td.dataset.email) : td.dataset.email;
  });
  document.getElementById('toggle-mask').textContent = masked ? 'Unmask' : 'Mask';
}
function autoRefreshToggle(){
  const checked = document.getElementById('auto-refresh').checked;
  if(timer){ clearInterval(timer); timer = null; }
  if(checked){ timer = setInterval(load, 30000); }
}

document.getElementById('load').addEventListener('click', load);

document.getElementById('export').addEventListener('click', () => {
  exportCsv(false);
});

document.getElementById('export-uniq').addEventListener('click', () => {
  exportCsv(true);
});

document.getElementById('toggle-mask').addEventListener('click', toggleMask);

document.getElementById('auto-refresh').addEventListener('change', autoRefreshToggle);

</script>
