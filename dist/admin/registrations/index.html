<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registrations — Tattoos • Barro • Paintings</title>
  <meta name="description" content="Portfolio and lessons by the artist.">
  <meta property="og:title" content="Registrations">
  <meta property="og:description" content="Portfolio and lessons by the artist.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/admin/registrations/">
  
  
  <meta property="og:image" content="/images/uploads/screenshot_20250816_154501.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="/assets/styles.css" rel="stylesheet">
  
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"Studio — Art &amp; Ink",
    "url":"",
  "logo":"/images/uploads/screenshot_20250816_154501.png",
    "sameAs":["https://instagram.com/yourhandle"]
  }</script>
  
  <script type="application/ld+json">{
    "@context":"https://schema.org",
    "@graph":[
    
    ]
  }</script>
  
  
  
  <link rel="preload" as="image" href="/images/uploads/screenshot_20250816_154501.png"/>
  
</head>
<body class="font-body text-gray-900 bg-white"> 
  <a href="#main" class="skip-link absolute top-[-40px] left-2 bg-black text-white px-3 py-2 focus:top-2 focus:outline-none">Skip to content</a>
  <header class="border-b border-black/10">
    <nav class="container flex items-center justify-between h-16">
      <a href="/" class="font-extrabold tracking-tight text-lg">Studio — Art &amp; Ink</a>
      <ul class="flex items-center gap-6">
        <li><a href="/gallery" class="hover:underline">Gallery</a></li>
        <li><a href="/lessons" class="hover:underline">Lessons</a></li>
        <li><a href="/about" class="hover:underline">About</a></li>
        <li><a href="/contact" class="hover:underline">Contact</a></li>
        <li><a href="/admin/" class="hover:underline">CMS</a></li>
  <li><a href="/admin/registrations" class="hover:underline text-xs opacity-70">Reg*</a></li>
  <li><a href="/admin-function-logs" class="hover:underline text-xs opacity-70">Logs*</a></li>
  
      </ul>
    </nav>
  </header>

  <main id="main" class="min-h-[70vh]">
    <section class="container py-12">
  <h1 class="text-3xl font-bold mb-6">Lesson Registrations</h1>
  <p class="text-sm mb-4">You must be logged in (admin) via Netlify Identity for this to work.</p>
  <div class="mb-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <label class="block text-sm">Slug filter
      <input id="filter-slug" class="border rounded px-2 py-1 w-full" placeholder="optional" />
    </label>
    <label class="block text-sm">Start date
      <input id="filter-start" type="date" class="border rounded px-2 py-1 w-full" />
    </label>
    <label class="block text-sm">End date
      <input id="filter-end" type="date" class="border rounded px-2 py-1 w-full" />
    </label>
    <div class="flex items-end gap-2 flex-wrap">
      <button id="load" class="btn">Load</button>
      <button id="export" class="btn">CSV</button>
      <button id="export-uniq" class="btn" title="Unique emails">Emails</button>
      <button id="toggle-mask" class="btn" title="Mask/unmask emails">Mask</button>
    </div>
  </div>
  <div class="text-sm mb-4">
    <label class="inline-flex items-center gap-2"><input type="checkbox" id="auto-refresh" /> <span>Auto refresh (30s)</span></label>
  </div>
  <div id="status" class="text-sm text-gray-600 mb-4">Idle</div>
  <div class="overflow-auto">
    <table class="min-w-full text-sm" id="table">
      <thead>
        <tr class="border-b">
          <th class="text-left py-2 pr-4">Lesson Slug</th>
          <th class="text-left py-2 pr-4">Name</th>
          <th class="text-left py-2 pr-4">Email</th>
          <th class="text-left py-2 pr-4">Registered At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<script>
let masked = true;
let timer = null;
function maskEmail(e){
  if(!masked) return e;
  const [u, d] = e.split('@');
  if(!d) return e;
  return u[0] + '***@' + d;
}
function buildUrl(base){
  const slug = document.getElementById('filter-slug').value.trim();
  const start = document.getElementById('filter-start').value;
  const end = document.getElementById('filter-end').value;
  const params = new URLSearchParams();
  if(slug) params.set('slug', slug);
  if(start) params.set('start', start);
  if(end) params.set('end', end);
  const qs = params.toString();
  return qs ? base + '?' + qs : base;
}
async function load(){
  const status = document.getElementById('status');
  status.textContent = 'Loading…';
  const url = buildUrl('/api/admin/registrations');
  try {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || 'Error');
    const tbody = document.querySelector('#table tbody');
    tbody.innerHTML = '';
    data.forEach(r => {
      if(filterDate(r.created_at)){
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `<td class='py-1 pr-4 font-mono text-xs'>${r.lesson_slug}</td><td class='py-1 pr-4'>${r.name}</td><td class='py-1 pr-4 email-cell' data-email='${r.email}'>${maskEmail(r.email)}</td><td class='py-1 pr-4'>${new Date(r.created_at).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      }
    });
    status.textContent = `${tbody.children.length} registrations shown.`;
  } catch(err){
    status.textContent = err.message;
  }
}
function filterDate(created){
  const start = document.getElementById('filter-start').value;
  const end = document.getElementById('filter-end').value;
  if(!start && !end) return true;
  const dt = new Date(created);
  if(start && dt < new Date(start)) return false;
  if(end){ const endDt = new Date(end); endDt.setDate(endDt.getDate()+1); if(dt >= endDt) return false; }
  return true;
}
function exportCsv(unique=false){
  const tableRows = Array.from(document.querySelectorAll('#table tbody tr'));
  if(unique){
    const emails = new Set();
    tableRows.forEach(r => emails.add(r.querySelector('.email-cell').dataset.email));
    const blob = new Blob([Array.from(emails).join('\n')], { type: 'text/plain' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'emails.txt'; a.click();
  } else {
    const lines = ['lesson_slug,name,email,created_at'];
    tableRows.forEach(r => {
      const tds = r.querySelectorAll('td');
      lines.push([tds[0].textContent, tds[1].textContent.replace(/,/g,' '), tds[2].dataset.email, tds[3].textContent].join(','));
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='registrations.csv'; a.click();
  }
}
function toggleMask(){
  masked = !masked;
  document.querySelectorAll('.email-cell').forEach(td => {
    td.textContent = masked ? maskEmail(td.dataset.email) : td.dataset.email;
  });
  document.getElementById('toggle-mask').textContent = masked ? 'Unmask' : 'Mask';
}
function autoRefreshToggle(){
  const checked = document.getElementById('auto-refresh').checked;
  if(timer){ clearInterval(timer); timer = null; }
  if(checked){ timer = setInterval(load, 30000); }
}

document.getElementById('load').addEventListener('click', load);

document.getElementById('export').addEventListener('click', () => {
  exportCsv(false);
});

document.getElementById('export-uniq').addEventListener('click', () => {
  exportCsv(true);
});

document.getElementById('toggle-mask').addEventListener('click', toggleMask);

document.getElementById('auto-refresh').addEventListener('change', autoRefreshToggle);

</section>
<script src="/assets/js/admin-registrations.js" defer></script>

  </main>

  <footer class="border-t border-black/10 py-10 mt-16">
    <div class="container flex flex-col md:flex-row items-center justify-between gap-6">
      <p class="text-sm">© Invalid DateTime — Studio — Art &amp; Ink · Amarante, Portugal</p>
      <div class="flex items-center gap-4">
        <a href="https://instagram.com/yourhandle" target="_blank" class="btn">Instagram</a>
        <a href="mailto:hello@example.com" class="btn">Email</a>
        <a href="/admin/" class="btn">Admin</a>
      </div>
    </div>
  </footer>
  <script src="/assets/js/blur-up.js" defer></script>
</body>
</html>